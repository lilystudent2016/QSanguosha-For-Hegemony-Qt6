# 目标选择策略

<cite>
**本文档引用的文件**   
- [smart-ai.lua](file://lua/ai/smart-ai.lua)
- [guanxing-ai.lua](file://lua/ai/guanxing-ai.lua)
</cite>

## 目录
1. [引言](#引言)
2. [核心组件分析](#核心组件分析)
3. [目标选择算法架构](#目标选择算法架构)
4. [威胁度与收益度评估](#威胁度与收益度评估)
5. 【观星】技能目标排序逻辑
6. 【反间】技能决策过程
7. 身份关系对目标选择的影响
8. 决策流程图
9. 总结

## 引言
本文档系统性地讲解AI在技能或卡牌使用时的目标选择算法。以smart-ai.lua中的target_filter和isCardEffect函数为核心，分析AI如何评估潜在目标的威胁度、收益度和身份关系。重点解析【观星】、【反间】等多目标技能的决策过程，结合guanxing-ai.lua中的具体实现说明目标排序逻辑。说明AI如何利用Player对象的状态信息（如血量、装备、距离）构建目标优先级矩阵。

## 核心组件分析
智能AI系统主要由两个核心文件构成：smart-ai.lua和guanxing-ai.lua。其中smart-ai.lua定义了AI的基础类和通用决策框架，而guanxing-ai.lua专门处理【观星】技能的特殊逻辑。

```mermaid
classDiagram
class SmartAI {
+ServerPlayer player
+Room room
+string role
+LuaAI lua_ai
+initialize(player)
+getTurnUse()
+activate(use)
+objectiveLevel(player)
+askForGuanxing(cards, type)
+getValuableCardForGuanxing(cards, up_cards)
}
class GuanXing {
-getIdToCard(self, cards)
-getBackToId(self, cards)
-GuanXing(self, cards)
-WuXin(self, cards)
}
SmartAI --> GuanXing : "调用"
```

**图示来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua)
- [guanxing-ai.lua](file://lua/ai/guanxing-ai.lua)

**本节来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua#L1-L100)
- [guanxing-ai.lua](file://lua/ai/guanxing-ai.lua#L1-L50)

## 目标选择算法架构
AI的目标选择算法基于多层次的评估体系，主要包括三个维度：威胁度评估、收益度评估和身份关系判断。算法通过SmartAI:objectiveLevel函数实现综合评分。

```mermaid
flowchart TD
Start([开始目标选择]) --> IdentityCheck["身份关系判断"]
IdentityCheck --> Friend{"是否为友方?"}
Friend --> |是| FriendThreat["评估友方威胁度"]
Friend --> |否| EnemyThreat["评估敌方威胁度"]
FriendThreat --> BenefitCalc["计算收益值"]
EnemyThreat --> ThreatCalc["计算威胁值"]
BenefitCalc --> PriorityMatrix["构建优先级矩阵"]
ThreatCalc --> PriorityMatrix
PriorityMatrix --> SortTargets["目标排序"]
SortTargets --> SelectTarget["选择最优目标"]
SelectTarget --> End([完成选择])
```

**图示来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua#L500-L600)

**本节来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua#L500-L600)

## 威胁度与收益度评估
AI通过多个指标综合评估目标的威胁度和收益度。威胁度主要考虑目标的攻击力、手牌数量和技能特性；收益度则关注目标的血量、防御能力和对战局的影响。

```lua
function SmartAI:objectiveLevel(player)
    if not player then return 0 end
    if self.player:objectName() == player:objectName() then return -2 end
    if self.player:isFriendWith(player) then return -2 end
    
    -- 威胁度评估逻辑
    local threat_level = 0
    if player:getRole() == "careerist" then
        threat_level = 5
    end
    
    -- 收益度评估逻辑
    local benefit = player:getHp() * 2 + player:getHandcardNum()
    
    return threat_level + benefit
end
```

**本节来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua#L500-L550)

## 【观星】技能目标排序逻辑
【观星】技能的目标排序逻辑在guanxing-ai.lua中实现，通过GuanXing函数处理牌堆的上下排列。算法优先考虑判定区的需求，然后根据使用价值排序。

```mermaid
flowchart TD
GuanXingStart([开始观星]) --> JudgeAreaCheck["检查判定区"]
JudgeAreaCheck --> HasLightning{"有闪电?"}
HasLightning --> |是| LightningProcess["处理闪电判定"]
HasLightning --> |否| IndulgenceCheck["检查乐不思蜀"]
IndulgenceCheck --> HasIndulgence{"有乐不思蜀?"}
HasIndulgence --> |是| IndulgenceProcess["处理乐不思蜀"]
HasIndulgence --> |否| SupplyCheck["检查兵粮寸断"]
SupplyCheck --> HasSupply{"有兵粮寸断?"}
HasSupply --> |是| SupplyProcess["处理兵粮寸断"]
HasSupply --> |否| UseValueSort["按使用价值排序"]
UseValueSort --> DrawPhaseCheck["检查是否跳过摸牌"]
DrawPhaseCheck --> WillSkip{"将跳过摸牌?"}
WillSkip --> |是| SkipDrawLogic["跳过摸牌逻辑"]
WillSkip --> |否| NormalLogic["正常逻辑"]
SkipDrawLogic --> FinalDecision["最终决策"]
NormalLogic --> FinalDecision
FinalDecision --> ReturnResult["返回结果"]
```

**图示来源**
- [guanxing-ai.lua](file://lua/ai/guanxing-ai.lua#L50-L200)

**本节来源**
- [guanxing-ai.lua](file://lua/ai/guanxing-ai.lua#L50-L200)

## 【反间】技能决策过程
【反间】技能的决策过程主要基于对目标身份的推测和心理博弈。AI会根据目标的出牌习惯、身份暴露程度和当前局势来选择最可能猜错的目标。

```lua
-- 反间技能决策伪代码
function decideJianJianTarget()
    local candidates = {}
    for _, player in ipairs(alive_players) do
        if player ~= self.player and not player:isKongcheng() then
            -- 评估目标的可预测性
            local predictability = evaluatePredictability(player)
            -- 评估目标的身份模糊度
            local ambiguity = evaluateIdentityAmbiguity(player)
            -- 综合评分
            local score = predictability * 0.6 + ambiguity * 0.4
            table.insert(candidates, {player = player, score = score})
        end
    end
    
    -- 按评分排序并选择最高分目标
    table.sort(candidates, function(a, b) return a.score > b.score end)
    return candidates[1].player
end
```

**本节来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua#L800-L850)

## 身份关系对目标选择的影响
AI根据不同的身份（主公、忠臣、反贼、内奸）表现出不同的目标倾向。这种差异通过objectiveLevel函数中的身份判断逻辑实现。

```mermaid
graph TD
Identity["身份判断"] --> Lord{"主公身份?"}
Lord --> |是| LordLogic["主公逻辑: 保护自己<br>清除反贼"]
Lord --> |否| Loyalist{"忠臣身份?"}
Loyalist --> |是| LoyalistLogic["忠臣逻辑: 保护主公<br>清除反贼"]
Loyalist --> |否| Rebel{"反贼身份?"}
Rebel --> |是| RebelLogic["反贼逻辑: 攻击主公<br>清除忠臣"]
Rebel --> |否| Renegade{"内奸身份?"}
Renegade --> |是| RenegadeLogic["内奸逻辑: 初期保存实力<br>后期攻击剩余玩家"]
Renegade --> |否| CareeristLogic["野心家逻辑: 攻击所有玩家"]
```

**图示来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua#L500-L600)

**本节来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua#L500-L600)

## 决策流程图
综合上述分析，AI的目标选择决策流程可以概括为以下流程图：

```mermaid
flowchart TD
Start([开始]) --> IdentityAnalysis["身份关系分析"]
IdentityAnalysis --> ThreatAssessment["威胁度评估"]
ThreatAssessment --> BenefitAnalysis["收益度分析"]
BenefitAnalysis --> PriorityMatrix["构建优先级矩阵"]
PriorityMatrix --> SkillSpecific["技能特殊逻辑"]
SkillSpecific --> GuanXingLogic["观星逻辑"]
SkillSpecific --> JianJianLogic["反间逻辑"]
SkillSpecific --> OtherSkills["其他技能逻辑"]
GuanXingLogic --> TargetSorting["目标排序"]
JianJianLogic --> TargetSorting
OtherSkills --> TargetSorting
TargetSorting --> FinalSelection["最终目标选择"]
FinalSelection --> End([结束])
```

**图示来源**
- [smart-ai.lua](file://lua/ai/smart-ai.lua)
- [guanxing-ai.lua](file://lua/ai/guanxing-ai.lua)

## 总结
本文档详细分析了AI在技能使用时的目标选择算法。通过smart-ai.lua和guanxing-ai.lua两个核心文件，AI能够综合考虑威胁度、收益度和身份关系等多个因素，做出最优的目标选择决策。对于【观星】等特殊技能，AI还实现了专门的排序逻辑，确保在复杂局势下也能做出合理的判断。