# 技术参考

<cite>
**本文档中引用的文件**   
- [structs.h](file://src/core/structs.h)
- [protocol.h](file://src/core/protocol.h)
- [skill.h](file://src/core/skill.h)
- [card.h](file://src/core/card.h)
- [main.cpp](file://src/main.cpp)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概览](#架构概览)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
《三国杀》是一款流行的桌面和在线游戏，该项目旨在克隆《三国杀》的在线版本。整个项目使用C++编写，采用Qt的图形视图框架作为游戏引擎。该项目支持多种扩展包，并使用Lua作为AI和扩展脚本语言。游戏具备完整的功能包、键盘快捷键、双击使用卡牌、卡牌排序等操作体验特性，并具有良好的可扩展性。

## 项目结构
项目采用分层架构设计，主要分为客户端、服务端、核心逻辑、UI界面、资源文件等模块。核心逻辑位于src/core目录下，包含游戏的核心数据结构、协议定义、技能系统和卡牌系统。

```mermaid
graph TB
subgraph "核心模块"
A[src/core]
A --> B[structs.h]
A --> C[protocol.h]
A --> D[skill.h]
A --> E[card.h]
end
subgraph "客户端模块"
F[src/client]
F --> G[client.h]
F --> H[clientplayer.h]
end
subgraph "服务端模块"
I[src/server]
I --> J[server.h]
I --> K[room.h]
end
subgraph "UI模块"
L[src/ui]
L --> M[dashboard.h]
L --> N[carditem.h]
end
A --> F
A --> I
A --> L
```

**图示来源**
- [structs.h](file://src/core/structs.h)
- [protocol.h](file://src/core/protocol.h)
- [skill.h](file://src/core/skill.h)
- [card.h](file://src/core/card.h)

**本节来源**
- [README.md](file://README.md)

## 核心组件
核心组件主要包括数据结构定义、网络协议、技能系统和卡牌系统。这些组件构成了游戏的基础框架，负责处理游戏状态、玩家交互、技能触发和卡牌效果等核心功能。

**本节来源**
- [structs.h](file://src/core/structs.h)
- [protocol.h](file://src/core/protocol.h)

## 架构概览
系统采用客户端-服务器架构，通过自定义协议进行通信。核心数据结构定义了游戏中的各种事件和状态，技能系统采用面向对象的设计模式，卡牌系统则通过继承机制实现不同类型卡牌的功能。

```mermaid
graph TD
A[客户端] --> |协议通信| B[服务器]
B --> C[核心逻辑]
C --> D[数据结构]
C --> E[技能系统]
C --> F[卡牌系统]
D --> G[DamageStruct]
D --> H[CardUseStruct]
D --> I[CardsMoveStruct]
E --> J[TriggerSkill]
E --> K[ViewAsSkill]
F --> L[SkillCard]
F --> M[BasicCard]
```

**图示来源**
- [structs.h](file://src/core/structs.h)
- [skill.h](file://src/core/skill.h)
- [card.h](file://src/core/card.h)

## 详细组件分析

### 数据结构分析
核心数据结构定义了游戏中的各种事件和状态，包括伤害结构、卡牌使用结构、卡牌移动结构等。

#### DamageStruct 分析
```mermaid
classDiagram
class DamageStruct {
+from : ServerPlayer*
+to : ServerPlayer*
+card : const Card*
+damage : int
+nature : Nature
+chain : bool
+transfer : bool
+by_user : bool
+reason : QString
+flags : QStringList
+getReason() : QString
}
class DamageStruct.Nature {
+Normal
+Fire
+Thunder
}
DamageStruct --> DamageStruct.Nature : "包含"
```

**图示来源**
- [structs.h](file://src/core/structs.h#L10-L50)

**本节来源**
- [structs.h](file://src/core/structs.h#L10-L100)

#### CardUseStruct 分析
```mermaid
classDiagram
class CardUseStruct {
+card : const Card*
+from : ServerPlayer*
+to : QList<ServerPlayer*>
+m_isOwnerUse : bool
+m_addHistory : bool
+m_isHandcard : bool
+nullified_list : QStringList
+disresponsive_list : QStringList
+index : int
+isValid(pattern) : bool
+parse(str, room) : void
+tryParse(usage, room) : bool
}
class CardUseStruct.CardUseReason {
+CARD_USE_REASON_UNKNOWN
+CARD_USE_REASON_PLAY
+CARD_USE_REASON_RESPONSE
+CARD_USE_REASON_RESPONSE_USE
}
CardUseStruct --> CardUseStruct.CardUseReason : "包含"
```

**图示来源**
- [structs.h](file://src/core/structs.h#L150-L200)

**本节来源**
- [structs.h](file://src/core/structs.h#L150-L250)

### 协议分析
网络协议定义了客户端与服务器之间的通信格式和命令类型。

#### 协议结构分析
```mermaid
classDiagram
class Packet {
+globalSerial : unsigned int
+localSerial : unsigned int
+command : CommandType
+packetDescription : PacketDescription
+messageBody : QVariant
+parse(raw) : bool
+toJson() : QByteArray
+toString() : QString
+getCommandType() : CommandType
}
class PacketDescription {
+S_DESC_UNKNOWN
+S_TYPE_REQUEST
+S_TYPE_REPLY
+S_TYPE_NOTIFICATION
+S_SRC_ROOM
+S_SRC_LOBBY
+S_SRC_CLIENT
+S_DEST_ROOM
+S_DEST_LOBBY
+S_DEST_CLIENT
}
class CommandType {
+S_COMMAND_UNKNOWN
+S_COMMAND_CHOOSE_CARD
+S_COMMAND_PLAY_CARD
+S_COMMAND_RESPONSE_CARD
+S_COMMAND_SHOW_CARD
+S_COMMAND_SHOW_ALL_CARDS
+S_COMMAND_EXCHANGE_CARD
+S_COMMAND_DISCARD_CARD
+S_COMMAND_INVOKE_SKILL
}
Packet --> PacketDescription : "使用"
Packet --> CommandType : "使用"
```

**图示来源**
- [protocol.h](file://src/core/protocol.h#L50-L100)

**本节来源**
- [protocol.h](file://src/core/protocol.h#L50-L150)

### 技能系统分析
技能系统采用面向对象的设计模式，通过继承实现不同类型的技能。

#### 技能类继承体系
```mermaid
classDiagram
class Skill {
+frequency : Frequency
+limit_mark : QString
+relate_to_place : QString
+attached_kingdom : QString
+attached_lord_skill : bool
+lord_skill : bool
+sources : QStringList
+getFrequency() : Frequency
+getLimitMark() : QString
+isAvailable() : bool
}
class ViewAsSkill {
+response_pattern : QString
+response_or_use : bool
+expand_pile : QString
+guhuo_type : QString
+viewFilter(selected, to_select) : bool
+viewAs(cards) : const Card*
}
class TriggerSkill {
+view_as_skill : const ViewAsSkill*
+events : QList<TriggerEvent>
+global : bool
+priority : QHash<TriggerEvent, double>
+getPriority() : int
+getDynamicPriority(e) : double
+triggerable(target) : bool
+record(triggerEvent, room, player, data) : void
+effect(triggerEvent, room, player, data, ask_who) : bool
}
class MasochismSkill {
+onDamaged(target, damage) : void
}
class PhaseChangeSkill {
+onPhaseChange(target) : bool
}
Skill <|-- ViewAsSkill : "继承"
Skill <|-- TriggerSkill : "继承"
TriggerSkill <|-- MasochismSkill : "继承"
TriggerSkill <|-- PhaseChangeSkill : "继承"
```

**图示来源**
- [skill.h](file://src/core/skill.h#L50-L100)

**本节来源**
- [skill.h](file://src/core/skill.h#L50-L200)

### 卡牌系统分析
卡牌系统通过继承机制实现不同类型卡牌的功能。

#### 卡牌类继承体系
```mermaid
classDiagram
class Card {
+m_suit : Suit
+m_number : int
+m_id : int
+m_skillName : QString
+handling_method : HandlingMethod
+show_skill : QString
+subcards : QList<int>
+target_fixed : bool
+mute : bool
+will_throw : bool
+has_preact : bool
+can_recast : bool
+transferable : bool
+flags : QStringList
+tag : QVariantMap
+getSuitString() : QString
+isRed() : bool
+isBlack() : bool
+getId() : int
+getNumber() : int
+setNumber(number) : void
+getNumberString() : QString
+getSuit() : Suit
+setSuit(suit) : void
+sameColorWith(other) : bool
+getColor() : Color
+getFullName(include_suit) : QString
+getLogName() : QString
+getName() : QString
+sameCardNameWith(other) : bool
+getSkillName(removePrefix) : QString
+setSkillName(skill_name) : void
+getDescription(inToolTip) : QString
+isMute() : bool
+willThrow() : bool
+canRecast() : bool
+hasPreAction() : bool
+getHandlingMethod() : HandlingMethod
+setCanRecast(can) : void
+setFlags(flag) : void
+setFlags(fs) : void
+hasFlag(flag) : bool
+clearFlags() : void
+setTag(key, data) : void
+removeTag(key) : void
+copyFrom(card) : void
+getPackage() : QString
+getClassName() : QString
+isVirtualCard() : bool
+isEquipped() : bool
+getCommonEffectName() : QString
+match(pattern) : bool
+addSubcard(card_id) : void
+addSubcard(card) : void
+getSubcards() : QList<int>
+clearSubcards() : void
+subcardString() : QString
+addSubcards(cards) : void
+addSubcards(subcards_list) : void
+subcardsLength() : int
+getType() : QString
+getSubtype() : QString
+getTypeId() : CardType
+isNDTrick() : bool
+targetFixed() : bool
+targetsFeasible(targets, Self) : bool
+targetRated(to_select, Self) : bool
+targetFilter(targets, to_select, Self) : bool
+targetFilter(targets, to_select, Self, maxVotes) : bool
+isAvailable(player) : bool
+getRealCard() : const Card*
+validate(cardUse) : const Card*
+validateInResponse(user) : const Card*
+validateAfter(cardUse) : void
+validateInResponseAfter(user) : void
+doPreAction(room, card_use) : void
+onUse(room, card_use) : void
+use(room, source, targets) : void
+onEffect(effect) : void
+isCancelable(effect) : bool
+checkTargetModSkillShow(use) : QStringList
+showSkill() : QString
+setShowSkill(skill_name) : void
+isKindOf(cardType) : bool
+getFlags() : QStringList
+isModified() : bool
+onNullified(target) : void
+CompareByNumber(a, b) : bool
+CompareBySuit(a, b) : bool
+CompareByType(a, b) : bool
+Clone(card) : Card*
+Suit2String(suit) : QString
+Parse(card_str) : const Card*
+toString(hidden) : QString
+toRealString() : QString
+getEffectName() : QString
+isTransferable() : bool
+setTransferable(transferbale) : void
+setSkillPosition(position) : void
+getSkillPosition() : QString
}
class SkillCard {
+user_string : QString
+setUserString(user_string) : void
+getUserString() : QString
+getSubtype() : QString
+getType() : QString
+getTypeId() : CardType
+toString(hidden) : QString
+extraCost(room, card_use) : void
+onUse(room, card_use) : void
}
class ArraySummonCard {
+validate(card_use) : const Card*
}
class TransferCard {
+targetFilter(targets, to_select, Self) : bool
+onEffect(effect) : void
}
class DummyCard {
+getSubtype() : QString
+getType() : QString
+toString(hidden) : QString
}
Card <|-- SkillCard : "继承"
SkillCard <|-- ArraySummonCard : "继承"
SkillCard <|-- TransferCard : "继承"
SkillCard <|-- DummyCard : "继承"
```

**图示来源**
- [card.h](file://src/core/card.h#L50-L100)

**本节来源**
- [card.h](file://src/core/card.h#L50-L200)

## 依赖分析
项目依赖于Qt框架、FMOD音频引擎、Freetype字体渲染库和Lua脚本语言。核心模块之间存在明确的依赖关系，客户端和服务端通过核心逻辑模块进行交互。

```mermaid
graph TD
A[Qt框架] --> B[图形界面]
C[FMOD] --> D[音频系统]
E[Freetype] --> F[字体渲染]
G[Lua] --> H[AI和扩展脚本]
I[src/core] --> J[数据结构]
I --> K[协议定义]
I --> L[技能系统]
I --> M[卡牌系统]
N[src/client] --> I
O[src/server] --> I
P[src/ui] --> I
```

**图示来源**
- [README.md](file://README.md)
- [src/core/structs.h](file://src/core/structs.h)

**本节来源**
- [README.md](file://README.md)

## 性能考虑
项目在设计时考虑了性能优化，采用轻量级的数据结构和高效的算法。卡牌移动和技能触发等频繁操作都经过优化，确保游戏运行流畅。

## 故障排除指南
常见问题包括编译错误、运行时崩溃和网络连接问题。建议检查依赖库版本、配置文件路径和网络设置。

**本节来源**
- [README.md](file://README.md)

## 结论
该项目是一个功能完整的《三国杀》在线游戏实现，采用模块化设计，具有良好的可扩展性和维护性。核心组件设计合理，代码结构清晰，适合进一步开发和定制。